<!DOCTYPE html>
<meta charset="utf-8">
<!-- IMPORTS -->
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<head>
    <link rel="stylesheet" type="text/css" href="OurStyles.css">
</head>
 
<body>

<div class="header" id="myHeader">
  
    <head>
        <h1> Changing The Game:<br> The NBA from 1976 to 2015</h1> 
        <p id="demo"></p>
    </head>

    <svg id="svg1" width="600" height="50"> 
    <filter id="this_image" x="0%" y="0%" width="100%" height="100%">
            <feImage xlink:href="NBALogo.png">
    </filter>
    </svg> 
</div>

<div id="line"></div>
<!-- <div id="demo1"></div> -->

<!---->
<div id="possplot"></div>
<div id="map"></div>

<!--
    STICKY HEADER SCRIPT
    Sampled from: https://www.w3schools.com/howto/howto_js_sticky_header.asp
-->
<script>
    //sticky header -- When the user scrolls the page, execute myFunction 
    window.onscroll = function() {myFunction()};
    // Get the header
    var header = document.getElementById("myHeader");
    // Get the offset position of the navbar
    var sticky = header.offsetTop;
    // Add the sticky class to the header when you reach its scroll position. Remove "sticky" when you leave the scroll position
    function myFunction() {
        if (window.pageYOffset >= sticky) {
            header.classList.add("sticky");
        } else {
            header.classList.remove("sticky");
        }
    }
</script>

<script>

//////-----READ IN DATA----/////////
// MAP DATA
mapcsv = 0
d3.csv("./Chris Globe/MapData.csv")
			.get(function(data){
			data.forEach(function(d){d.Year=+d.Year})
			window['mapcsv'] = data});

mapjson = 0   
d3.json("./Chris Globe/world-110m2.json")
		.get(function(data){
			window['mapjson'] = data});


// LUCA LINE DATA
var parseYear = d3.timeParse("%Y");	
lucadata = 0
d3.csv("./Luca-Line/data.csv")
		.get(function(data){
		data.forEach(function(d){d.X3PA = +d.X3PA;
                                d.X3P = +d.X3P; 
                                d.date =parseYear(d.Year).getFullYear()})
		window['lucadata'] = data});

// POSSESION DATA
// parse the date / time
var parseTime = d3.timeParse("%Y-%m-%d");
possdata = 0
d3.csv("./Pace/possessions.csv")
	.get(function(data){
		data.forEach(function(d){d.date = parseTime(d.date);
      d.max = +d.max;
      d.min = +d.min;
      d.mean = +d.mean;})
      window['possdata'] = data})
		
/////---------------------//////////


/////---SLIDER SVG------//////
var svg = d3.select("svg"),
    tmargin = {right: 5, left: 5},
    twidth = +svg.attr("width") - tmargin.left - tmargin.right,
    theight = +svg.attr("height");

var x_t = d3.scaleLinear()
    .domain([1976, 2017]) 
    .range([0, twidth])
    .clamp(true);

var slider = svg.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + tmargin.left + "," + theight / 2 + ")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", x_t.range()[0])
    .attr("x2", x_t.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() { update_year(x_t.invert(d3.event.x)); }) 
        .on("end drag", function() { update_year(x_t.invert(d3.event.x));}));  

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
  .data(x_t.ticks(11))
  .enter().append("text")
    .attr("x", x_t)
    .attr("text-anchor", "middle")
    .text(function(d) { return d ; });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 25)
    .attr("filter", "url(#this_image)");


// Add Gratuitous animated intro
slider.transition() // Gratuitous intro!
    .duration(1500)
    .tween("hue", function() {
      var i = d3.interpolate(1976, 2000);
      return function(t) { update_year(i(t)); };
    });

//////------- SLIDER FUNCTIONS ------////////
//Change color on slide 
// NEEDS WORK
function hue(h) {
  handle.attr("cx", x_t(h));
  svg.style("background-color", d3.hsl(h, 0.8, 0.8));
}

//-------MAIN-----------//
var yearout = 0

function update_year(h) {
	handle.attr("cx", x_t(h));
	ye = Math.round(h);
	document.getElementById("demo").innerHTML =  ye 
	
	//SET GLOBAL VARIABLES
	window['year'] = ye;
	window['yearout'] = ye;
	
	//EXECUTE PLOT FUNCTIONS
	//build_bar(ye);
	lucaline(ye,lucadata);
	newmapbuilder(ye,mapcsv,mapjson);
	possplot(ye,possdata);

    if (year <= 1985) {
        //document.getElementById("demo1").innerHTML = "";
        document.getElementById("demo1").innerHTML = "<img src='MJ23.png' style='width:100%; height:100%; margin: 2% '>"
    }
	
	if (year > 1985) {
		document.getElementById("demo1").innerHTML = yearout + " We are now entering the golden age!";
	}
	if (year > 1992) {
		document.getElementById("demo1").innerHTML = yearout + " Matt has been born!";
	}
}

///////----------------INITIATE SVGS FOR EACH PLOT-------//////////////
// **** MAP
var mwidth = 960,
    mheight = 500;

var projection = d3.geoMercator()
    .center([0, 5 ])
    .scale(150)
    .rotate([-10,0]);

var svg = d3.select("#map").append("svg")
    .attr("width", "100%")//mwidth)
    .attr("height", mheight);

var path = d3.geoPath()
    .projection(projection);

//////--------- LUCA LINE
// FUNCTIONS
function mousemove_3pt(d,i) {
    if (d.Year >= 1980) {
      tooltip_3pt
        .transition()		
        .duration(200)		
        .style("opacity", .9);
    tooltip_3pt.html("3PT shots attempted: " + d3.format(".1f")(d.X3PA) +
                "<br>3PT shots made: " + d3.format(".1f")(d.X3P) +
                "<br>3PT shots %: " + d3.format(".1%")(d.X3P/d.X3PA))
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");
    }
  }
function mouseout_3pt(d,i) {
    tooltip_3pt
        .transition()		
        .duration(500)		
        .style("opacity", 0)
};
var tooltip_3pt = d3.select("body").append("div").attr("class", "tooltip").style("opacity",0);

// set the dimensions and margins of the graph by div
var lineDiv = document.getElementById("line");

var lmargin = {top: 40, right: 100, bottom: 40, left: 50}, 
	lwidth = lineDiv.clientWidth - lmargin.left - lmargin.right,
	//lheight = lineDiv.clientHeight - lmargin.top - lmargin.bottom;
    //lwidth = screen.width-500 - lmargin.left - lmargin.right,
    lheight = 500 - lmargin.top - lmargin.bottom;

// set the ranges
var x = d3.scaleTime().range([0, lwidth]);
var y = d3.scaleLinear().range([lheight, 0]);

// define the area
var area = d3.area()
    .x(function(d) { return x(d.date); }) //Year
    .y0(lheight)
    .y1(function(d) { return y(d.X3P); });

// define the line
var valueline = d3.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.X3PA); });

// append the svg obgect to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin

var lsvg = d3.select("#line").append("svg")
	//.attr("width", lineDiv.clientWidth)
    .attr("width", lwidth + lmargin.left + lmargin.right )
    .attr("height", lheight + lmargin.top + lmargin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + lmargin.left + "," + lmargin.top + ")");


//////------- Possesions
// Functions

function mousemove_max(d,i) {
    tooltip_poss
        .transition()		
        .duration(200)		
        .style("opacity", .9);
    tooltip_poss.html("Team: " + d.team_max + "<br>Possesions per game: " + d.max)
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");
}
function mousemove_min(d,i) {
    tooltip_poss
        .transition()		
        .duration(200)		
        .style("opacity", .9);
    tooltip_poss.html("Team: " + d.team_min + "<br>Possesions per game: " + d.min)
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");
}
function mousemove(d,i) {
    tooltip_poss
        .transition()		
        .duration(200)		
        .style("opacity", .9);
    tooltip_poss.html("Possesions per game: " + d.mean)
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");

}
function mouseout(d,i) {
    tooltip_poss
        .transition()		
        .duration(500)		
        .style("opacity", 0)
};

var tooltip_poss = d3.select("body").append("div").attr("class", "tooltip").style("opacity",0);

// Possession SVG
// set the dimensions and margins of the graph
var possDiv = document.getElementById("possplot");

var pmargin = {top: 20, right: 20, bottom: 30, left: 50},
	pwidth = possDiv.clientWidth - pmargin.left - pmargin.right,
    //pwidth = screen.width -500- pmargin.left - pmargin.right,
    pheight = 500 - pmargin.top - pmargin.bottom;

// set the ranges
var x_poss = d3.scaleTime().range([0, pwidth]);
var y_poss = d3.scaleLinear().range([pheight, 0]);

var psvg = d3.select("#possplot").append("svg")
    .attr("width", "99%")//pwidth + pmargin.left + pmargin.right)
    .attr("height", pheight + pmargin.top + pmargin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + pmargin.left + "," + pmargin.top + ")");


/////////---------FUNCTIONS FOR CREATING & UPDATING PLOTS---------////////////
/////------POSSESION PLOT FUNCTION
function possplot(ye,data){

    psvg.selectAll("g").remove();
    psvg.selectAll("text").remove();
    psvg.selectAll("circle").remove();

  
  var datafilt = data.filter(function(data) { return data.year == ye ; })

  // Scale the range of the data
  x_poss.domain(d3.extent(data, function(d) { return d.date; }));
  y_poss.domain([65, 5+d3.max(data, function(d) { return d.max; })]);
      
  // MAXIMUM scatterplot
  psvg.selectAll("dot")
      .data(data)
    .enter().append("circle")
      .attr("r", 5)
      .style("fill", '#ff041d')
      //.style("opacity", 0.1)
      .style("opacity", function(d){
      			if(parseInt(d.year) == ye){return 1}
      			else{return .1}
      			})
      .attr("cx", function(d) { return x_poss(d.date); })
      .attr("cy", function(d) { return y_poss(d.max); })
      .on("mousemove",mousemove_max)
		.on("mouseout",mouseout);

  // AVERAGE scatterplot
  psvg.selectAll("dot")
      .data(data)
    .enter().append("circle")
      .attr("r", 5)
      .style("fill", '#ffd504')
      //.style("opacity", 0.1)
      .style("opacity", function(d){
      			if(parseInt(d.year) == ye){return 1}
      			else{return .1}
      			})
      .attr("cx", function(d) { return x_poss(d.date); })
      .attr("cy", function(d) { return y_poss(d.mean); })
		.on("mousemove",mousemove)
		.on("mouseout",mouseout);

  // MINIMUM scatterplot
  psvg.selectAll("dot")
      .data(data)
    .enter().append("circle")
      .attr("r", 5)
      .style("fill", '#049bff')
      //.style("opacity", 0.1)
      .style("opacity", function(d){
      			if(parseInt(d.year) == ye){return 1}
      			else{return .1}
      			})
      .attr("cx", function(d) { return x_poss(d.date); })
      .attr("cy", function(d) { return y_poss(d.min); })
        .on("mousemove",mousemove_min)
		.on("mouseout",mouseout);

  // Add the X Axis
  psvg.append("g")
      .attr("transform", "translate(0," + pheight + ")")
      .call(d3.axisBottom(x_poss));
      //.tickFormat(d3.format(".4r")));

  // Add the Y Axis
  psvg.append("g")
      .call(d3.axisLeft(y_poss));

  // Title
  psvg.append("text")
        .attr("x", (pwidth / 2))             
        .attr("y", 0)
        .attr("text-anchor", "middle")  
        .style("font-size", "1.2em")
        .attr("font-weight", "bold")
        .text("Number of possessions per game");

  var classes = d3.scaleOrdinal()
    .domain(["Yearly maximum", "Yearly average", "Yearly minimum"])
    .range(["#ff041d", "#ffd504", "#049bff"]);

  var legend = psvg.selectAll(".legend")
      .data(classes.domain())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(-135," + i * 20 + ")"; }); //-210

  legend.append("rect")
        .attr("x", pwidth + 10)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", classes);

  legend.append("text")
        .attr("x", pwidth + 30)
        .attr("y", 9)
        .attr("dy", ".35em")
        .text(function(d) { return d; });


}

////---------LUCA LINE FUNCTION
function lucaline(ye,lucadata){
  sye = ""+ye;
  
  lsvg.selectAll("path").remove();
  lsvg.selectAll("line").remove();
  lsvg.selectAll("circle").remove();
  lsvg.selectAll("g").remove();
  
  // find min and max for axis
    x.domain(d3.extent(lucadata, function(d) { return d.date; }));
    y.domain([0, 2 + d3.max(lucadata, function(d) { return d.X3PA; })]);
  
  // filter out our year
  var data = lucadata.filter(function(d) { return d.Year <= ye ; }) //year filter
  //var data = lucadata.filter(function(d){return d.Year <= ye;})
  
  // add the area
    lsvg.append("path")
       .data([data])
       .attr("class", "area")
       .attr("d", area);

  // add the valueline path.
  lsvg.append("path")
      .data([data])
      .attr("class", "line")
      .attr("d", valueline);

    //add the dots
    lsvg.selectAll("dot")  
        .data(data)                   
      .enter().append("circle")               
        .attr("r", 3.5)
        .attr("class", "circle")   
        //.style("fill", "steelblue")
        .attr("cx", function(d) { return x(d.date); })     
        .attr("cy", function(d) { return y(d.X3PA); })
        .on("mousemove",mousemove_3pt)
        .on("mouseout",mouseout_3pt);

    //var xValues = lucadata.map(function(d){return parseFloat(d.Year);});
  // add the X Axis
  lsvg.append("g")
      .attr("transform", "translate(0," + lheight + ")")
      .call(d3.axisBottom(x)
      .tickFormat(d3.format(".4r")));

  // add the Y Axis
  lsvg.append("g")
      .call(d3.axisLeft(y));

    // Title
    lsvg.append("text")
            .attr("x", (lwidth / 2))             
            .attr("y", 0 - (lmargin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "1.2em")
            .attr("font-weight", "bold")
            .text("Number of 3-pt shots attempted and made per game");

    // X axis label
    lsvg.append('text')
      .attr('x', lwidth + 0)
      .attr('y', lheight + 25)
      .attr('class', 'mylabel')
      .text('Year');


    //legend
    var legend = lsvg.append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(20, 10)');

    legend.append('text')
      .attr('x', 10)
      .attr('y', -10)
      .text('Legend');

    legend.append('path')
      .attr('class', 'line')
      .attr('d', 'M10,10L80,10');

    legend.append('circle')
      .attr('class', 'circle')
      .attr('r', 3.5)
      .attr('cx', 45)
      .attr('cy', 10);

    legend.append('text')
      .attr('x', 85)
      .attr('y', 15)
      .text('3PT Attemped');

    legend.append('rect')
      .style("fill", 'lightsteelblue')
      .attr('width',  70)
      .attr('height', 20)
      .attr('x', 10)
      .attr('y', 30);

    legend.append('text')
      .attr('x', 85)
      .attr('y', 45)
      .text('3PT Made');

}


///////-------NEW MAPBUILDER (NO ZOOM)
function newmapbuilder(ye,mapcsv,mapjson){
    svg.selectAll("circle").remove();
var g = svg.append("g");
var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);


//Load map
g.selectAll("path")
      .data(topojson.object(mapjson, mapjson.objects.countries)
          .geometries)
    .enter()
      .append("path")
      .attr("d", path)

//Load values
    //var m_data = mapcsv.filter(function(d) { return d.Year == ye; }); //year filter
    g.selectAll("circle")
       .data(mapcsv)
       .enter()
       .filter(function(d) { return d.Year == ye; })
       .append("circle")
            .attr("cx", function(d) {
                    return projection([d.Longitude, d.Latitude])[0];
            })
            .attr("cy", function(d) {
                    return projection([d.Longitude, d.Latitude])[1];
            })
            .on("mouseover", function(d) {		
                    div.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                    div .html(d.Player+ "<br/>"  + d.birth_city+", "+ d.birth_country)	
                        .style("left", (d3.event.pageX) + "px")		
                        .style("top", (d3.event.pageY - 28) + "px");	
                    })					
            .on("mouseout", function(d) {		
                div.transition()		
                    .duration(500)		
                    .style("opacity", 0)
            })	

            .attr("r", 1.5)
            .style("fill", "#2b8cbe");

//zoom and pan
// var zoom = d3.zoom()
//     .on("zoom",function() {
//         g.attr("transform", d3.event.transform);
//         g.selectAll("circle")
//             .attr("d", path.projection(projection));
//         g.selectAll("path")  
//             .attr("d", path.projection(projection)); 
// 
//   });
// svg.call(zoom)

}

//UPDATE BAR (TEST)
function build_bar(ye){
year = ye
nbar.selectAll(".bar").remove();
nbar.selectAll("text").remove();
nbar.selectAll("g").remove();
        
d3.csv("../Data/team_means.csv", function(error, data) {
  if(error) throw error;

  data.forEach(function(d){
  		d.Year = +d.Year
    	d.height = +d.height
    	d.Age = +d.Age
    	d.Age = Math.round(d.Age)
    
  })
  
  //Filter data based on slider year
  var data = data.filter(function(d) { return d.Year == window['year']; });
	//console.log(data)
  
    data.sort(function(a, b) {
        return d3.ascending(a.height, b.height)
      });
  
  // Scale the range of the data in the domains
  x.domain([0, d3.max(data, function(d){ return d.height; })])
  y.domain(data.map(function(d) { return d.Tm; }));
  

  //append the rectangles for the bar chart
  nbar.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("width", function(d) {return x(d.height); } )
      .attr("y", function(d) { return y(d.Tm); })
      .attr("height", y.bandwidth())
      .attr("fill", function(d) { return z(Math.round(d["Age"])); }); 
      

  // add the x Axis
  nbar.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  nbar.append("text")             
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (height + margin.top - 5) + ")")
      .style("text-anchor", "middle")
      .text("Height (cm)");

  nbar.append("text")
  	  .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (-10) + ")")
      .style("text-anchor", "middle")
      .text("NBA Teams by Height in "+year);

  // add the y Axis
  nbar.append("g")
      .call(d3.axisLeft(y));
      
// Add Legend
var legend = nbar.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(d3.map(data.sort(function(a, b) {
        return d3.ascending(a.Age, b.Age)
      })
      , function(d){return d["Age"];}).keys())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width + 50) //19
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z);

  legend.append("text")
      .attr("x", width + 50 - 5) 
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d+" yrs"; });


      
});

} //function close


</script>


</body>