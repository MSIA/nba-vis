<!DOCTYPE html>
<meta charset="utf-8">
<style>

.ticks {
  font: 10px sans-serif;
}

.track,
.track-inset,
.track-overlay {
  stroke-linecap: round;
}

.track {
  stroke: #000;
  stroke-opacity: 0.3;
  stroke-width: 10px;
}

.track-inset {
  stroke: #ddd;
  stroke-width: 8px;
}

.track-overlay {
  pointer-events: stroke;
  stroke-width: 50px;
  stroke: transparent;
  cursor: crosshair;
}

.handle {
  fill: #fff;
  stroke: #000;
  stroke-opacity: 0.5;
  stroke-width: 1.25px;
}



path {
  stroke: lightblue;
  stroke-width: 0.25px;
  fill: lightgray;
}

div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 175px;					
    height: 28px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}

.area {
  fill: lightsteelblue;
}
</style>


<!-- python -m http.server 8001 -->
<svg width="960" height="500">
  <filter id="this_image" x="0%" y="0%" width="100%" height="100%">
        <feImage xlink:href="https://windycitizensports.files.wordpress.com/2012/04/lebron-crying.jpg"/>
  </filter>
</svg>  
<body>

<!-- Sample text output !-->
<p id="demo"></p>
<p id="demo1"></p>



<script src="//d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script>

//////-----Can we read data in separately?----/////////
mapcsv = 0
d3.csv("./Chris Globe/MapData.csv")
			.get(function(data){
			data.forEach(function(d){d.Year=+d.Year})
			window['mapcsv'] = data});

mapjson = 0   
d3.json("./Chris Globe/world-110m2.json")
		.get(function(data){
			window['mapjson'] = data});
			
lucadata = 0
d3.csv("./Luca-Line/data.csv")
		.get(function(data){
		data.forEach(function(d){d.X3PA = +d.X3PA ; d.X3P = +d.X3P;})
		window['lucadata'] = data});
		
/////-------- Data in END -------------//////////


//Slider svg
var svg = d3.select("svg"),
    tmargin = {right: 50, left: 50},
    twidth = +svg.attr("width") - tmargin.left - tmargin.right,
    theight = +svg.attr("height");


var x_t = d3.scaleLinear()
    .domain([1976, 2010])
    .range([0, twidth])
    .clamp(true);

var slider = svg.append("g") 
    .attr("class", "slider")
    .attr("transform", "translate(" + tmargin.left + "," + theight / 2 + ")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", x_t.range()[0])
    .attr("x2", x_t.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        //.on("start drag", function() { hue(x_t.invert(d3.event.x)); }) //); // this changes color
        .on("end drag", function() { update_year(x_t.invert(d3.event.x));}));  //updates year

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
  .data(x_t.ticks(11))
  .enter().append("text")
    .attr("x", x_t)
    .attr("text-anchor", "middle")
    .text(function(d) { return d ; });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 25)
    .attr("filter", "url(#this_image)");

slider.transition() // Gratuitous intro!
    .duration(750)
    .tween("hue", function() {
      var i = d3.interpolate(1976, 2000);
      return function(t) { update_year(i(t)); };
    });






//Change color on slide (Turned off)
function hue(h) {
  handle.attr("cx", x_t(h));
  svg.style("background-color", d3.hsl(h, 0.8, 0.8));
}

//Update global year variable, update text
var yearout = 0
function update_year(h) {
	handle.attr("cx", x_t(h));
	ye = Math.round(h);
	document.getElementById("demo").innerHTML = ye +" --- " + yearout;
	
	window['year'] = ye;
	window['yearout'] = ye;

	//build_bar(ye);
	lucaline(ye,lucadata);
	newmapbuilder(ye,mapcsv,mapjson);

  if (year <= 1985) {
    document.getElementById("demo1").innerHTML = "";
  }
	
	if (year > 1985) {
		document.getElementById("demo1").innerHTML = yearout + " We are now entering the golden age!";
	}
	if (year > 1992) {
		document.getElementById("demo1").innerHTML = yearout + " Matt has been born!";
	}
}


//INCORPORATE MAP
var mwidth = 960,
    mheight = 500;

var projection = d3.geoMercator()
    .center([0, 5 ])
    .scale(150)
    .rotate([-10,0]);

var svg = d3.select("body").append("svg")
    .attr("width", mwidth)
    .attr("height", mheight);

var path = d3.geoPath()
    .projection(projection);

// INCORPORATE LUCA LINE
//------------------------------------------------
// set the dimensions and margins of the graph
var lmargin = {top: 20, right: 20, bottom: 30, left: 50},
    lwidth = 960 - lmargin.left - lmargin.right,
    lheight = 500 - lmargin.top - lmargin.bottom;

// set the ranges
var x = d3.scaleLinear().range([0, lwidth]);
var y = d3.scaleLinear().range([lheight, 0]);

// define the area
var area = d3.area()
    .x(function(d) { return x(d.Year); })
    .y0(lheight)
    .y1(function(d) { return y(d.X3P); });

// define the line
var valueline = d3.line()
    .x(function(d) { return x(d.Year); })
    .y(function(d) { return y(d.X3PA); });

// append the svg obgect to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var lsvg = d3.select("body").append("svg")
    .attr("width", lwidth + lmargin.left + lmargin.right)
    .attr("height", lheight + lmargin.top + lmargin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + lmargin.left + "," + lmargin.top + ")");


/////--------------LUCA LINE FUNCTION-----------------//////
function lucaline(ye,lucadata){

lsvg.selectAll("path").remove();
lsvg.selectAll("line").remove();
lsvg.selectAll("g").remove();

// get the data
d3.csv("./Luca-Line/data.csv", function(error, data) {
  if (error) throw error;

  // format the data
  data.forEach(function(d) {
      d.X3PA = +d.X3PA;
      d.X3P = +d.X3P;
  });

  
  // find min and max for axis
  var datamax = d3.max(data, function(d){return d.Year;})
  var datamin = d3.min(data, function(d){return d.Year;})

  
  // filter out our year
  var data = data.filter(function(d) { return d.Year <= ye ; }) //year filter

  
  // scale the range of the data
  x.domain([datamin, datamax]);
  y.domain([0, d3.max(data, function(d) { return d.X3PA; })]);

  // add the area
    lsvg.append("path")
       .data([data])
       .attr("class", "area")
       .attr("d", area);

  // add the valueline path.
  lsvg.append("path")
      .data([data])
      //.filter(function(d) { return d.Year <= window['year']; })
      .attr("class", "line")
      .attr("d", valueline);

  // add the X Axis
  lsvg.append("g")
      .attr("transform", "translate(0," + lheight + ")")
      .call(d3.axisBottom(x));

  // add the Y Axis
  lsvg.append("g")
      .call(d3.axisLeft(y));

});

}


//////------------NEW MAPBUILDER (NO ZOOM)-----------///////
function newmapbuilder(ye,mapcsv,mapjson){

var g = svg.append("g");

var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);


//Load map
g.selectAll("path")
      .data(topojson.object(mapjson, mapjson.objects.countries)
          .geometries)
    .enter()
      .append("path")
      .attr("d", path)



//Load values
    //var m_data = mapcsv.filter(function(d) { return d.Year == ye; }); //year filter
    g.selectAll("circle")
       .data(mapcsv)
       .enter()
       .filter(function(d) { return d.Year == ye; })
       .append("circle")
            .attr("cx", function(d) {
                    return projection([d.Longitude, d.Latitude])[0];
            })
            .attr("cy", function(d) {
                    return projection([d.Longitude, d.Latitude])[1];
            })
            .on("mouseover", function(d) {		
                    div.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                    div .html(d.Player+ "<br/>"  + d.birth_city+", "+ d.birth_country)	
                        .style("left", (d3.event.pageX) + "px")		
                        .style("top", (d3.event.pageY - 28) + "px");	
                    })					
            .on("mouseout", function(d) {		
                div.transition()		
                    .duration(500)		
                    .style("opacity", 0)
            })	

            .attr("r", 1.5)
            .style("fill", "#2b8cbe");

// zoom and pan
var zoom = d3.zoom()
    .on("zoom",function() {
        g.attr("transform", d3.event.transform);
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });
svg.call(zoom)

}



//////------ORIGINAL MAPBUILDER-------///////
function mapbuilder(ye){



var g = svg.append("g");

var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);

// load and display the World
d3.json("./Chris Globe/world-110m2.json", function(error, topology) {

// load and display the cities
d3.csv("./Chris Globe/MapData.csv", function(error, data) {
    data.forEach(function(d){
  		d.Year = +d.Year    
  })
    var data = data.filter(function(d) { return d.Year == ye; });
    g.selectAll("circle")
       .data(data)
       .enter()
       .append("circle")
            .attr("cx", function(d) {
                    return projection([d.Longitude, d.Latitude])[0];
            })
            .attr("cy", function(d) {
                    return projection([d.Longitude, d.Latitude])[1];
            })
            .on("mouseover", function(d) {		
                    div.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                    div .html(d.Player+ "<br/>"  + d.birth_city+", "+ d.birth_country)	
                        .style("left", (d3.event.pageX) + "px")		
                        .style("top", (d3.event.pageY - 28) + "px");	
                    })					
            .on("mouseout", function(d) {		
                div.transition()		
                    .duration(500)		
                    .style("opacity", 0)
            })	

            .attr("r", 1.5)
            .style("fill", "#2b8cbe");
});


g.selectAll("path")
      .data(topojson.object(topology, topology.objects.countries)
          .geometries)
    .enter()
      .append("path")
      .attr("d", path)
});

// zoom and pan

var zoom = d3.zoom()
    .on("zoom",function() {
        g.attr("transform", d3.event.transform);
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });

svg.call(zoom)
}


//----------UPDATE BAR (TEST)----------;;;;
function build_bar(ye){
year = ye
nbar.selectAll(".bar").remove();
nbar.selectAll("text").remove();
nbar.selectAll("g").remove();
        
d3.csv("../Data/team_means.csv", function(error, data) {
  if(error) throw error;

  data.forEach(function(d){
  		d.Year = +d.Year
    	d.height = +d.height
    	d.Age = +d.Age
    	d.Age = Math.round(d.Age)
    
  })
  
  //Filter data based on slider year
  var data = data.filter(function(d) { return d.Year == window['year']; });
	//console.log(data)
  
    data.sort(function(a, b) {
        return d3.ascending(a.height, b.height)
      });
  
  // Scale the range of the data in the domains
  x.domain([0, d3.max(data, function(d){ return d.height; })])
  y.domain(data.map(function(d) { return d.Tm; }));
  

  //append the rectangles for the bar chart
  nbar.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("width", function(d) {return x(d.height); } )
      .attr("y", function(d) { return y(d.Tm); })
      .attr("height", y.bandwidth())
      .attr("fill", function(d) { return z(Math.round(d["Age"])); }); 
      

  // add the x Axis
  nbar.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  nbar.append("text")             
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (height + margin.top - 5) + ")")
      .style("text-anchor", "middle")
      .text("Height (cm)");

  nbar.append("text")
  	  .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (-10) + ")")
      .style("text-anchor", "middle")
      .text("NBA Teams by Height in "+year);

  // add the y Axis
  nbar.append("g")
      .call(d3.axisLeft(y));
      
// Add Legend
var legend = nbar.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(d3.map(data.sort(function(a, b) {
        return d3.ascending(a.Age, b.Age)
      })
      , function(d){return d["Age"];}).keys())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width + 50) //19
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z);

  legend.append("text")
      .attr("x", width + 50 - 5) 
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d+" yrs"; });


      
});

} //function close


</script>

</body>